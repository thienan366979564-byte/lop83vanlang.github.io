<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Điểm Tốt - Admin Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: all 0.3s ease-in-out;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            z-index: 1000;
        }
        .message-box.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-3xl shadow-xl p-8 max-w-4xl w-full mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Sổ Điểm Tốt</h1>
            <p class="text-gray-600">Thưởng điểm và theo dõi các thành viên!</p>
            <p id="user-id-display" class="mt-2 text-sm text-gray-400"></p>
        </header>

        <!-- Login/Logout & Admin buttons -->
        <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4">
            <!-- Login Form for Admin -->
            <form id="admin-login-form" class="space-y-4 w-full md:w-auto">
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                    <input type="text" id="admin-username" placeholder="Tên đăng nhập" class="w-full md:w-40 border border-gray-300 rounded-md p-2">
                    <input type="password" id="admin-password" placeholder="Mật khẩu" class="w-full md:w-40 border border-gray-300 rounded-md p-2">
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-indigo-700 transition-colors transform hover:scale-105">
                        Đăng nhập Admin
                    </button>
                </div>
            </form>
            <div id="admin-actions" class="flex space-x-4 mt-4 md:mt-0 hidden">
                <button onclick="window.showAddPersonModal()" id="add-person-btn" class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105">
                    + Thêm Người Mới
                </button>
                <button onclick="window.logout()" id="logout-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-red-600 transition-colors transform hover:scale-105">
                    Đăng xuất
                </button>
            </div>
        </div>

        <!-- User list rendered by JS -->
        <section id="people-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></section>

        <!-- History Log -->
        <section>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Lịch Sử Hoạt Động</h2>
            <div id="history-log" class="bg-gray-50 p-4 rounded-xl max-h-80 overflow-y-auto">
                <p class="text-gray-500 text-center">Lịch sử sẽ hiển thị tại đây...</p>
            </div>
        </section>
    </div>

    <!-- Add New Person Modal -->
    <div id="add-person-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-center">Thêm Người Mới</h3>
            <div class="space-y-4">
                <div>
                    <label for="new-person-name" class="block text-gray-700 font-semibold mb-1">Tên:</label>
                    <input type="text" id="new-person-name" placeholder="Ví dụ: An" class="w-full border border-gray-300 rounded-md p-2">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="window.closeAddPersonModal()" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-400">Hủy</button>
                <button onclick="window.addPerson()" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-600">Thêm</button>
            </div>
        </div>
    </div>
    
    <!-- Rename Modal -->
    <div id="rename-person-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-center">Đổi Tên</h3>
            <div class="space-y-4">
                <div>
                    <label for="rename-person-name" class="block text-gray-700 font-semibold mb-1">Tên mới:</label>
                    <input type="text" id="rename-person-name" placeholder="Tên mới" class="w-full border border-gray-300 rounded-md p-2">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="window.closeRenamePersonModal()" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-400">Hủy</button>
                <button id="rename-confirm-btn" onclick="window.renamePerson()" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-600">Đổi Tên</button>
            </div>
        </div>
    </div>

    <!-- Custom Point Modal -->
    <div id="custom-point-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-sm">
            <h3 id="custom-modal-title" class="text-2xl font-bold mb-4 text-center">Cộng Điểm Tùy Chỉnh</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal-points" class="block text-gray-700 font-semibold mb-1">Số điểm:</label>
                    <input type="number" id="modal-points" value="1" class="w-full border border-gray-300 rounded-md p-2">
                </div>
                <div>
                    <label for="modal-reason" class="block text-gray-700 font-semibold mb-1">Lý do:</label>
                    <input type="text" id="modal-reason" placeholder="Ví dụ: Giúp đỡ bố mẹ" class="w-full border border-gray-300 rounded-md p-2">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="window.closeCustomPointModal()" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-400">Hủy</button>
                <button id="add-custom-btn" onclick="window.addCustomPoints()" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-indigo-600">Cộng Điểm</button>
                <button id="subtract-custom-btn" onclick="window.subtractCustomPoints()" class="bg-rose-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-rose-600">Trừ Điểm</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-sm">
            <h3 class="text-2xl font-bold mb-4 text-center">Admin Panel</h3>
            <p class="text-center text-gray-600 mb-6">Bạn có thể quản lý các tính năng admin tại đây.</p>
            <div class="flex flex-col space-y-4">
                <button onclick="window.resetAllScores()" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-red-600 transition-colors transform hover:scale-105">
                    Đặt Lại Tất Cả Điểm
                </button>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="window.closeAdminModal()" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-400">Đóng</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-sm">
            <h3 id="confirm-modal-title" class="text-2xl font-bold mb-4 text-center"></h3>
            <p id="confirm-modal-message" class="text-center text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-cancel" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-400">Hủy</button>
                <button id="confirm-modal-ok" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-xl hover:bg-red-600">Đồng ý</button>
            </div>
        </div>
    </div>

    <!-- Message box replacing alert() -->
    <div id="message-box" class="message-box bg-green-500 text-white py-3 px-6 rounded-full shadow-lg">
        <p id="message-text">Thông báo</p>
    </div>

    <script type="module">
        // Import necessary Firebase libraries from CDN.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, updateDoc, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define global variables for use in the application.
        let app, db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let selectedPersonId = null;
        let isAdmin = false;
        let confirmActionCallback = null;
        
        // Variables to hold unsubscribe functions for real-time listeners.
        let unsubscribePeople = null;
        let unsubscribeHistory = null;
        
        // Hardcoded admin credentials as requested.
        const ADMIN_USERNAME = 'adminthienan';
        const ADMIN_PASSWORD = 'adminadmin123';

        // Get references to HTML elements.
        const peopleContainer = document.getElementById('people-container');
        const historyLog = document.getElementById('history-log');
        const userIdDisplay = document.getElementById('user-id-display');
        const adminActionsDiv = document.getElementById('admin-actions');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminUsernameInput = document.getElementById('admin-username');
        const adminPasswordInput = document.getElementById('admin-password');
        const addPersonModal = document.getElementById('add-person-modal');
        const renamePersonModal = document.getElementById('rename-person-modal');
        const customPointModal = document.getElementById('custom-point-modal');
        const adminModal = document.getElementById('admin-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmTitle = document.getElementById('confirm-modal-title');
        const confirmMessage = document.getElementById('confirm-modal-message');
        const confirmOkBtn = document.getElementById('confirm-modal-ok');
        const confirmCancelBtn = document.getElementById('confirm-modal-cancel');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        // Attach events to the confirmation modal.
        confirmOkBtn.onclick = () => {
            if (confirmActionCallback) {
                confirmActionCallback();
            }
            closeConfirmModal();
        };
        confirmCancelBtn.onclick = closeConfirmModal;

        // Function to show a message box.
        function showMessage(text, isError = false) {
            messageText.textContent = text;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Function to handle admin login.
        async function handleAdminLogin(event) {
            event.preventDefault(); // Prevent form submission
            
            const username = adminUsernameInput.value.trim();
            const password = adminPasswordInput.value.trim();
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdmin = true;
                adminLoginForm.classList.add('hidden');
                adminActionsDiv.classList.remove('hidden');
                showMessage("Đăng nhập Admin thành công!");
                updateUIForAdmin();
            } else {
                showMessage("Sai tên đăng nhập hoặc mật khẩu.", true);
            }
        }
        
        // Function to update the UI when the user becomes an admin.
        function updateUIForAdmin() {
            // Re-render the people list to show admin controls.
            const peopleCollectionRef = collection(db, `artifacts/${appId}/public/data/people`);
            onSnapshot(peopleCollectionRef, (snapshot) => {
                peopleContainer.innerHTML = '';
                if (snapshot.empty) {
                    peopleContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">Chưa có người nào. Hãy thêm một người!</p>';
                } else {
                    snapshot.docs.forEach((d) => {
                        const person = d.data();
                        const personId = d.id;
                        renderPersonCard(personId, person.name, person.score);
                    });
                }
            }, (error) => {
                console.error("Lỗi khi lắng nghe danh sách người dùng:", error);
                showMessage("Lỗi khi tải danh sách người dùng. Vui lòng thử lại.", true);
            });
        }

        // Function to handle logout.
        window.logout = function() {
            isAdmin = false;
            adminLoginForm.classList.remove('hidden');
            adminActionsDiv.classList.add('hidden');
            showMessage("Đã đăng xuất.");
            updateUIForAdmin(); // Re-render to hide admin controls.
        }

        // Function to initialize Firebase and set up listeners for everyone.
        async function initFirebase() {
            try {
                // Check if Firebase config is valid.
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. App cannot function without it.");
                    showMessage("Lỗi: Cấu hình Firebase không hợp lệ.", true);
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use onAuthStateChanged to ensure listeners are only set up after authentication.
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID người dùng: ${userId}`;
                        // Set up Firestore listeners after successful authentication.
                        setupFirestoreListeners();
                    } else {
                        // Sign in with custom token or anonymously if not available.
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Lỗi khi khởi tạo Firebase:", error);
                showMessage("Lỗi khi khởi tạo Firebase.", true);
            }
        }
        
        // Function to set up Firestore listeners.
        function setupFirestoreListeners() {
            // Unsubscribe from any existing listeners to prevent duplicates.
            if (unsubscribePeople) unsubscribePeople();
            if (unsubscribeHistory) unsubscribeHistory();

            console.log("Setting up Firestore listeners...");
            // Reference to the collection that stores the user list.
            const peopleCollectionRef = collection(db, `artifacts/${appId}/public/data/people`);
            
            // Listen for changes to the user list.
            unsubscribePeople = onSnapshot(peopleCollectionRef, (snapshot) => {
                peopleContainer.innerHTML = '';
                if (snapshot.empty) {
                    peopleContainer.innerHTML = '<p class="text-gray-500 text-center col-span-full">Chưa có người nào. Hãy thêm một người!</p>';
                } else {
                    snapshot.docs.forEach((d) => {
                        const person = d.data();
                        const personId = d.id;
                        renderPersonCard(personId, person.name, person.score);
                    });
                }
            }, (error) => {
                console.error("Lỗi khi lắng nghe danh sách người dùng:", error);
                showMessage("Lỗi khi tải danh sách người dùng. Vui lòng thử lại.", true);
            });

            // Reference to the history collection.
            const historyCollectionRef = collection(db, `artifacts/${appId}/public/data/history`);
            const historyQuery = query(historyCollectionRef);
            
            // Listen for changes to the history.
            unsubscribeHistory = onSnapshot(historyQuery, (snapshot) => {
                historyLog.innerHTML = '';
                if (snapshot.empty) {
                    historyLog.innerHTML = '<p class="text-gray-500 text-center">Chưa có hoạt động nào...</p>';
                } else {
                    // Sort the history data in JavaScript to avoid index errors.
                    const historyItems = snapshot.docs.map(doc => doc.data());
                    historyItems.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    
                    historyItems.slice(0, 20).forEach((historyItem) => {
                        const timestamp = historyItem.timestamp ? new Date(historyItem.timestamp).toLocaleString('vi-VN') : 'Không rõ thời gian';
                        const p = document.createElement('p');
                        p.className = 'text-gray-700 border-b border-gray-200 py-2 last:border-b-0';
                        p.innerHTML = `<span class="font-bold">${historyItem.personName}</span> nhận <span class="font-bold ${historyItem.points > 0 ? 'text-green-600' : 'text-red-600'}">${historyItem.points}</span> điểm vì: "${historyItem.reason}"<br><span class="text-xs text-gray-500">(${timestamp})</span>`;
                        historyLog.appendChild(p);
                    });
                }
            }, (error) => {
                console.error("Lỗi khi lắng nghe lịch sử:", error);
                showMessage("Lỗi khi tải lịch sử. Vui lòng thử lại.", true);
            });
        }

        // Function to render a person's card.
        function renderPersonCard(personId, name, score) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl p-6 shadow-md transition-transform transform hover:scale-105';
            
            const actionsHTML = isAdmin ? `
                <div class="flex space-x-2">
                    <button onclick="window.showRenamePersonModal('${personId}', '${name}')" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                        </svg>
                    </button>
                    <button onclick="window.deletePerson('${personId}')" class="text-gray-400 hover:text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            ` : '';
            
            const customPointsBtnHTML = isAdmin ? `
                <button onclick="window.showCustomPointModal('${personId}', '${name}')" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-indigo-600 transition-colors">
                    Cộng Điểm Tùy Chỉnh
                </button>
            ` : '';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-semibold text-gray-800">${name}</h2>
                    ${actionsHTML}
                </div>
                <div class="flex items-center justify-center">
                    <span class="text-5xl font-bold text-indigo-600">${score || 0}</span>
                    <span class="text-2xl font-semibold text-indigo-600 ml-2">điểm</span>
                </div>
                <div class="mt-4 flex flex-col space-y-2">
                    ${customPointsBtnHTML}
                </div>
            `;
            peopleContainer.appendChild(card);
        }

        // Function to add a new person.
        window.addPerson = async function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            const name = document.getElementById('new-person-name').value.trim();
            if (name === "") {
                showMessage("Tên không được để trống.", true);
                return;
            }

            try {
                const peopleCollectionRef = collection(db, `artifacts/${appId}/public/data/people`);
                await addDoc(peopleCollectionRef, {
                    name: name,
                    score: 0
                });
                closeAddPersonModal();
                showMessage(`Đã thêm ${name} thành công!`);
            } catch (error) {
                console.error("Lỗi khi thêm người:", error);
                showMessage("Lỗi khi thêm người mới.", true);
            }
        }

        // Function to delete a person.
        window.deletePerson = async function(personId) {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            showConfirmModal("Xóa Người Dùng", "Bạn có chắc chắn muốn xóa người này? Thao tác này không thể hoàn tác!", async () => {
                try {
                    const personDocRef = doc(db, `artifacts/${appId}/public/data/people`, personId);
                    await deleteDoc(personDocRef);
                    showMessage("Đã xóa người thành công!");
                } catch (error) {
                console.error("Lỗi khi xóa người:", error);
                showMessage("Lỗi khi xóa người.", true);
            }
        });
        }
        
        // Function to show the confirmation modal.
        function showConfirmModal(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmActionCallback = callback;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }
        
        // Function to close the confirmation modal.
        function closeConfirmModal() {
            confirmationModal.classList.remove('flex');
            confirmationModal.classList.add('hidden');
            confirmActionCallback = null;
        }

        // Function to show the add person modal.
        window.showAddPersonModal = function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            addPersonModal.classList.remove('hidden');
            addPersonModal.classList.add('flex');
            document.getElementById('new-person-name').value = '';
        }

        // Function to close the add person modal.
        window.closeAddPersonModal = function() {
            addPersonModal.classList.remove('flex');
            addPersonModal.classList.add('hidden');
        }
        
        // Function to show the rename modal.
        window.showRenamePersonModal = function(personId, currentName) {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            selectedPersonId = personId;
            document.getElementById('rename-person-name').value = currentName;
            renamePersonModal.classList.remove('hidden');
            renamePersonModal.classList.add('flex');
        }

        // Function to close the rename modal.
        window.closeRenamePersonModal = function() {
            renamePersonModal.classList.remove('flex');
            renamePersonModal.classList.add('hidden');
        }
        
        // Function to rename a person.
        window.renamePerson = async function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            if (!selectedPersonId) return;

            const newName = document.getElementById('rename-person-name').value.trim();
            if (newName === "") {
                showMessage("Tên không được để trống.", true);
                return;
            }

            try {
                const personDocRef = doc(db, `artifacts/${appId}/public/data/people`, selectedPersonId);
                await updateDoc(personDocRef, { name: newName });
                closeRenamePersonModal();
                showMessage("Đã đổi tên thành công!");
            } catch (error) {
                console.error("Lỗi khi đổi tên:", error);
                showMessage("Lỗi khi đổi tên.", true);
            }
        }

        // Function to show the custom point modal.
        window.showCustomPointModal = function(personId, personName) {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            selectedPersonId = personId;
            document.getElementById('custom-modal-title').textContent = `Cộng/Trừ Điểm cho ${personName}`;
            document.getElementById('modal-points').value = 1;
            document.getElementById('modal-reason').value = '';
            customPointModal.classList.remove('hidden');
            customPointModal.classList.add('flex');
        }

        // Function to close the custom point modal.
        window.closeCustomPointModal = function() {
            customPointModal.classList.remove('flex');
            customPointModal.classList.add('hidden');
            selectedPersonId = null;
        }

        // Function to handle custom point addition.
        window.addCustomPoints = function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            const points = parseInt(document.getElementById('modal-points').value);
            const reason = document.getElementById('modal-reason').value || "Lý do không xác định";

            if (selectedPersonId && points > 0) {
                updateScore(selectedPersonId, points, reason);
                closeCustomPointModal();
            } else {
                showMessage("Số điểm phải lớn hơn 0.", true);
            }
        }
        
        // Function to handle custom point subtraction.
        window.subtractCustomPoints = function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            const points = parseInt(document.getElementById('modal-points').value);
            const reason = document.getElementById('modal-reason').value || "Lý do không xác định";

            if (selectedPersonId && points > 0) {
                updateScore(selectedPersonId, -points, reason);
                closeCustomPointModal();
            } else {
                showMessage("Số điểm phải lớn hơn 0.", true);
            }
        }
        
        // Function to update score and history.
        async function updateScore(personId, points, reason) {
            if (!isAdmin || !db) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }

            try {
                const personDocRef = doc(db, `artifacts/${appId}/public/data/people`, personId);

                // Update the score in Firestore.
                const personDocSnapshot = await getDoc(personDocRef);
                const currentScore = personDocSnapshot.data().score;
                await updateDoc(personDocRef, {
                    score: Math.max(0, currentScore + points) // Ensure score is not negative
                });

                // Add a history entry.
                const historyCollectionRef = collection(db, `artifacts/${appId}/public/data/history`);
                await addDoc(historyCollectionRef, {
                    personId: personId,
                    personName: personDocSnapshot.data().name,
                    reason: reason,
                    points: points,
                    timestamp: Date.now()
                });
                
                showMessage("Điểm đã được cập nhật thành công!");
            } catch (error) {
                console.error("Lỗi khi cập nhật điểm:", error);
                showMessage("Lỗi khi cập nhật điểm.", true);
            }
        }

        // Function to show the admin modal.
        window.showAdminModal = function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền truy cập.", true);
                return;
            }
            adminModal.classList.remove('hidden');
            adminModal.classList.add('flex');
        }

        // Function to close the admin modal.
        window.closeAdminModal = function() {
            adminModal.classList.remove('flex');
            adminModal.classList.add('hidden');
        }

        // Function to reset all scores.
        window.resetAllScores = async function() {
            if (!isAdmin) {
                showMessage("Bạn không có quyền thực hiện thao tác này.", true);
                return;
            }
            showConfirmModal("Đặt Lại Điểm", "Bạn có chắc chắn muốn đặt lại điểm của TẤT CẢ mọi người về 0 không? Thao tác này không thể hoàn tác!", async () => {
                try {
                    const peopleCollectionRef = collection(db, `artifacts/${appId}/public/data/people`);
                    const querySnapshot = await getDocs(peopleCollectionRef);
                    
                    const updatePromises = querySnapshot.docs.map(docSnapshot => {
                        return updateDoc(doc(db, `artifacts/${appId}/public/data/people`, docSnapshot.id), {
                            score: 0
                        });
                    });
                    
                    await Promise.all(updatePromises);
                    showMessage("Đã đặt lại điểm của tất cả mọi người thành công!");
                    closeAdminModal();
                } catch (error) {
                    console.error("Lỗi khi đặt lại điểm:", error);
                    showMessage("Lỗi khi đặt lại điểm. Vui lòng thử lại.", true);
                }
            });
        }
        
        // Start the application.
        window.onload = function() {
            initFirebase();
            adminLoginForm.addEventListener('submit', handleAdminLogin);
        };
    </script>
</body>
</html>
